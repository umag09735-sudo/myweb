<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Technical Evaluation ‚Äì Bidder Page¬†3</title>

 <!-- External libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.worker.min.js"></script>
  <script src="https://unpkg.com/pdf-lib@1.16.0/dist/pdf-lib.min.js"></script>
<style>
  :root {
  --left-w: 200px; /* changed from 390px */
  --toolbar-h: 52px;
}
:root {
  --flag-size: 28px;
  --flag-clr: #f44336;
}

#app{display:flex;height:100%;width:100%}

    /* right column - now full screen */
    #right-panel{flex:1 1 auto;display:flex;flex-direction:column;overflow:hidden;width:100%}
    #toolbar{height:var(--toolbar-h);display:flex;align-items:center;flex-wrap:wrap;gap:.55rem;padding:0 .9rem;border-bottom:1px solid #ccc;background:#f6f6f6}
    #toolbar button{padding:.32rem .7rem;border:1px solid #555;background:#fff;cursor:pointer;font-size:.84rem; border-radius: 10px;}
    #toolbar button.active{background:#cde4ff}
    #toolbar input[type="range"] {width: 80px;}

    #pdf-container{flex:1 1 auto;overflow:auto;background:#e7e7e7;padding:1rem;transform-origin:top center;position:relative}
    #pages-wrapper {
      position: absolute;
      top: 0;
      left: 50%;
      transform-origin: top center;
    }

    .page-wrapper{position:relative;margin:0 auto 1.3rem auto;box-shadow:0 2px 4px rgba(0,0,0,.18)}
    canvas.page-canvas{display:block;width:100%;height:auto}
    .overlay{position:absolute;top:0;left:0;right:0;bottom:0;cursor:crosshair}

    /* annotation shapes */
    .rect,.highlight,.freehand{position:absolute;pointer-events:none;box-sizing:border-box}
    .rect{border:2px solid red}
    .highlight{background:rgba(255,255,0,.45)}
    .freehand{background:transparent}
    .text-annotation{position:absolute;background:rgba(255,255,255,.9);padding:2px 4px;border:1px solid #222;font-size:.75rem;max-width:50%;cursor:move;user-select:none}
    .flag {
  position: absolute;
  width: var(--flag-size);
  height: var(--flag-size);
  background: var(--flag-clr);
  clip-path: polygon(0 0, 100% 0, 100% 70%, 50% 100%, 0 70%);
  display: flex;
  align-items: center;
  justify-content: center;
  color: #fff;
  font-size: .64rem;
  font-weight: 600;
  user-select: none;
  cursor: pointer;
  z-index: 100;
  transition: transform 0.2s;
}
    .overlay {
  pointer-events: auto; /* was missing or overridden */
}

    /* Magnifier styles */
    .magnifier, .frozen-magnifier {
      position: absolute;
      border: 2px solid #000;
      pointer-events: none;
      overflow: hidden;
      z-index: 999;
      background: white;
      box-shadow: 0 0 10px rgba(0,0,0,0.5);
    }
    .magnifier canvas,
    .frozen-magnifier canvas {
      transform-origin: top left;
      position: absolute;
    }
    



  html,body{margin:0;height:100%;font-family:system-ui,-apple-system,"Segoe UI",Roboto,sans-serif}
  /* ‚ñë‚ñë banner ‚ñë‚ñë */
  #summary {
  display: flex;
  align-items: center;
  justify-content: space-between;
  background: white;
  color: black;
  padding: 0 12px;
  height: 32px; /* single-line height */
  overflow: hidden;
  position: relative;
}
  #summary h2{font-size:.9rem;margin:0;white-space:wrap;}
  #summary p{margin:0;font-size:.6rem;display:flex;gap:6px;white-space:nowrap}
  
  #info{display:flex;flex-wrap:wrap;gap:12px;align-items:center}
  #backBtn {
  background: #fff;
  color: #1e88e5;
  border: none;
  border-radius: 4px;
  padding: 2px 8px;
  font-size: 0.75rem;
  font-weight: 600;
  cursor: pointer;
  margin-right: 8px;
  position: absolute;
  left: 8px;
  top: 4px;
  z-index: 2;
}
  /* ‚ñë‚ñë layout ‚ñë‚ñë */
  #app{display:flex;height:calc(100% - var(--toolbar-h))}
  #left-panel {
  flex: 0 0 var(--left-w);
  width: 380px;
  border-right: 1px solid #ddd;
  background: #fafafa;
  overflow-y: auto;
  padding: 1rem;
}

  .item-row{display:flex;align-items:center;gap:.45rem;margin-bottom:.55rem}
  .item-row label{flex:1;font-size:.8rem}
  .item-row input[type=text],.item-row input[type=number]{flex:1;padding:.24rem .4rem;font-size:.75rem}
  /* ‚ñë‚ñë compact custom boxes ‚ñë‚ñë */
  .box{display:flex;flex-direction:column;gap:6px;padding:6px 0 10px;margin-bottom:12px;border-left:3px solid #2196f3;background:#f1faff;border-radius:4px;padding-left:10px}
  .box label{font-weight:700;font-size:.78rem}
  .inline{display:flex;flex-wrap:nowrap;gap:1px;align-items:center;font-size:.75rem}
  .box > label {
  cursor: pointer;
}

  .inline label{font-weight:normal}
  .remark-line{margin-left:.4rem;font-size:.75rem;display:flex;align-items:center;gap:6px}
  .remark-line input{width:160px;padding:4px 6px;font-size:.72rem;border:1px solid #ccc;border-radius:4px}
  .warn{color:#d32f2f;font-size:.7rem;margin-left:.4rem;margin-top:2px;font-weight:600}
  /* ‚ñë‚ñë buttons ‚ñë‚ñë */
  .btn-wide{margin-top:.8rem;width:100%;padding:.48rem 0;font-size:.8rem;font-weight:600;border:none;border-radius:4px;cursor:pointer;color:#fff}
 
  /* ‚îÄ‚îÄ Simple accordion styling ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
.box > label{              /* heading */
  display:block;
  cursor:pointer;
  background:#f3f3f3;
  padding:6px 10px;
  font-weight:600;
  border:1px solid #d0d0d0;
  border-radius:4px;
}
.box-content{              /* collapsible body */
  padding:10px;
  border:1px solid #e0e0e0;
  border-top:none;
  border-radius:0 0 4px 4px;
}
#ticker {
  white-space: nowrap;
  overflow: hidden;
  width: 100%;
  margin-left: 80px;
}

#ticker span {
  display: inline-block;
  padding-left: 100%;
  animation: scroll 80s linear infinite;
  font-size: 1.2rem;
}

@keyframes scroll {
  0%   { transform: translateX(0); }
  100% { transform: translateX(-100%); }
}
#leftContent {
  display: none;
  flex-direction: column;
  gap: 12px;
  transition: all 0.3s ease;
}


#floatingPanel {
  position: absolute;
  top: 60px;
  left: 20px;
  width: 400px;
  background: #fafafa;
  border: 1px solid #ccc;
  border-radius: 6px;
  box-shadow: 2px 2px 6px rgba(0,0,0,0.15);
  z-index: 1000;
  cursor: grab;
}



#leftContent {
  padding: 1rem;
  display: none; /* toggle manually or leave visible */
  flex-direction: column;
  gap: 12px;
}
#pdf-container {
  flex: 1 1 auto;
  overflow: auto;
  background: #e7e7e7;
  padding: 1rem;
  transform-origin: top center;
  position: relative;
  display: flex;
  justify-content: center;
}

#pages-wrapper {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 20px;
  transform-origin: top center;
}

.page-wrapper {
  position: relative;
  margin: 0 auto;
  box-shadow: 0 2px 4px rgba(0,0,0,.18);
  background: white;
}

.page-canvas {
  display: block;
  width: 100%;
  height: auto;
}

/* Add to your existing styles */
.two-page-wrapper {
  display: flex;
  gap: 20px;
  margin-bottom: 1.3rem;
}

.single-page-wrapper {
  position: relative;
  box-shadow: 0 2px 4px rgba(0,0,0,.18);
  background: white;
}

/* Adjust the main container */
#pages-wrapper {
  position: relative;
  top: 0;
  left: 50%;
  transform-origin: top center;
  display: flex;
  flex-direction: column;
  align-items: center;
}
/* Sticky note and bubble button */
#stickyBubble {
position:fixed;
bottom:20px;
right:20px;
width:50px;
height:50px;
border-radius:50%;
background:#1e88e5;
color:white;
display:flex;
align-items:center;
justify-content:center;
font-size:1.5rem;
font-weight:bold;
cursor:grab;
z-index:2000;
box-shadow:0 2px 6px rgba(0,0,0,0.3);
}

#stickyPad {
  position: fixed;
  top: 120px;
  left: 120px;
  width: 250px;
  height: 300px;
  background: #fff9c4;
  border: 1px solid #ccc;
  border-radius: 6px;
  box-shadow: 2px 2px 6px rgba(0,0,0,0.2);
  display: flex;
  flex-direction: column;
  z-index: 2001;

}

.sticky-toolbar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: #fbc02d;
  padding: 2px 4px;
  font-size: 0.8rem;
  cursor: move;   /* üîπ added */
}


.sticky-toolbar button {
  border: none;
  background: transparent;
  cursor: pointer;
  margin: 0 2px;
  font-weight: bold;
}

#noteText {
  flex: 1;
  border: none;
  resize: none;
  padding: 6px;
  background: transparent;
  font-size: 0.85rem;
}
#notePage{
  background-color:#fff9c4;
  width: 25px;
  border: none;
}
.drag-handle {
  cursor: move;
  font-weight: bold;
  margin-right: 6px;
}

.sticky-toolbar {
  display: flex;
  align-items: center;
  gap: 4px;
  background: #fbc02d;
  padding: 2px 4px;
  font-size: 0.8rem;
}

.sticky-toolbar #noteHeading {
  flex: 1;
  text-align: center;
  font-weight: bold;
  background: #fbc02d;
  border: none;
}

.sticky-footer {
  text-align: right;
  padding: 4px;
  border-top: 1px solid #ccc;
}

.sticky-footer button {
  padding: 3px 8px;
  font-size: 0.8rem;
  cursor: pointer;
}
.note-meta {
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 6px;
  padding: 4px;
  background: #fff7a3;
  border-bottom: 1px solid #ccc;
  font-size: 0.8rem;
}

.note-meta input {
  width: 60px;
  padding: 2px 4px;
  font-size: 0.8rem;
  border: 1px solid #aaa;
  border-radius: 3px;
}
/* Popup overlay */
.popup-overlay {
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.5);
  display: flex; justify-content: center; align-items: center;
  z-index: 3000;
}

/* Popup content box */
.popup-content {
margin: auto;              /* ensures centering */
  top: auto; left: auto;     /* override accidental offsets */
  position: relative;
  background: white;
  padding: 30px;
  border-radius: 12px;
  width: 800px;           /* wider */
  max-height: 90vh;
  overflow-y: auto;
  box-shadow: 0 6px 20px rgba(0,0,0,0.25);
}

/* Popup heading */
.popup-content h2 {
  margin-top: 0;
  margin-bottom: 20px;
  text-align: center;
  font-size: 24px;
  color: #2c3e50;
}

/* Grid layout for form */
.popup-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;   /* two columns */
  gap: 20px;
}

.popup-grid .form-group {
  display: flex;
  flex-direction: column;
}

/* Inputs */
.popup-grid label {
  margin-bottom: 6px;
  font-weight: bold;
  color: #34495e;
}
.popup-grid input {
  padding: 10px;
  border: 1px solid #ccc;
  border-radius: 6px;
  font-size: 15px;
}

/* Hide number input spinners (Chrome, Safari, Edge) */
#tenderPopup input[type=number]::-webkit-inner-spin-button, 
#tenderPopup input[type=number]::-webkit-outer-spin-button {
  -webkit-appearance: none;
  margin: 0;
}

/* Hide number input spinners (Firefox) */
#tenderPopup input[type=number] {
  -moz-appearance: textfield;
}

/* Buttons row */
.btn-bar {
  display: flex;
  justify-content: center;
  gap: 15px;
  margin-top: 25px;
}
.btn-bar button {
  flex: 1;
  padding: 12px;
  border: none;
  border-radius: 6px;
  font-size: 16px;
  cursor: pointer;
  color: #fff;
}

#popup-nextBtn { background: #3498db; }
#popup-cancelBtn { background: #7f8c8d; }

.full-width {
  grid-column: span 2;  /* makes it span both columns */
}
/* Table styling */
#biddersTable {
  width: 100%;
  border-collapse: collapse;
  margin-bottom: 20px;
}

#biddersTable th, 
#biddersTable td {
  border: 1px solid #ccc;
  padding: 6px 8px;
  text-align: center;
  font-size: 14px;
}

/* Narrow columns */
#biddersTable th:first-child,
#biddersTable td:first-child {
  width: 60px;   /* Srl No */
}

#biddersTable th:last-child,
#biddersTable td:last-child {
  width: 120px;  /* Bidder No */
}

/* Input styling */
#biddersTable input {
  width: 100%;
  border: none;
  outline: none;
  font-size: 14px;
  padding: 4px;
  background: transparent; /* make it blend in */
  text-align: left;
}
/* Bidders popup buttons */
#popup-backBtn {
  background: #e67e22; /* orange */
  color: #fff;
}

#popup-continueBtn {
  background: #3498db; /* blue */
  color: #fff;
}

#popup-biddersCancelBtn {
  background: #7f8c8d; /* grey */
  color: #fff;
}
/* Toolbar bidders dropdown */
.toolbar-select {
  min-width: 100px;
  height: 32px;
  padding: 4px 8px;
  border: 1px solid #ccc;
  border-radius: 6px;
  vertical-align: middle;
  margin-left: 8px;
  font-size: 14px;
}
/* For Chrome, Safari, Edge */
input[type=number]::-webkit-inner-spin-button,
input[type=number]::-webkit-outer-spin-button {
  -webkit-appearance: none;
  margin: 0;
}

/* For Firefox */
input[type=number] {
  -moz-appearance: textfield;
}
#abcCloseBtn {
  background: #3498db;  /* blue */
  color: white;
}


</style>
</head>
<body>

<!-- ‚ñë‚ñë banner ‚ñë‚ñë -->
<div id="summary">
  <button id="resetBtn" style="background:none;border:none;padding:0;cursor:pointer;font-size:20px;">üîÑ</button>

  <div id="ticker"><span id="scrollText">Loading tender details‚Ä¶</span></div>
</div>

<div id="app">
    <!-- ‚ñ∏ Viewer / Toolbar -->
    <section id="right-panel">
      <div id="toolbar">
        <input type="file" id="file-input" accept="application/pdf" multiple style="width: 150px;" />
        <button data-tool="rect" title="rectangle">‚ñ°</button>
        
        <button data-tool="highlight" title="highlighter">üñçÔ∏è</button>
       
        <button data-tool="text" title="text">A</button>
        <button data-tool="flag" title="flag">üö©</button>
        
        <button id="copy-flags" title="copy flag detail">üìù<sup style="font-size: 7px;">üö©</sup></button>
        <button id="remove-flag" title="remove flag">‚ùå<sup style="font-size: 7px;">üö©</sup></button>
        <button id="zoom-in">+</button>
        <button id="zoom-out">‚àí</button>
        <button id="rotate-left" title="rotate">‚ü≤</button>
        <button id="rotate-right" title="rotate">‚ü≥</button>
        <button id="undo-btn" title="undo">‚Ü©</button>
        <button id="redo-btn" title="redo">‚Ü™</button>
        <button id="toggleMagnifier" title="magnifier">üîç</button>
        
        <input type="range" id="zoomRange" min="1" max="4" value="2" step="0.1" title="Magnification Level">
        <input type="range" id="radiusRange" min="50" max="300" value="150" step="10" title="Magnifier Size">
        <button onclick="downloadFlaggedPages()">‚≠≥</button>
        <input type="file" id="file-input" multiple hidden />
        
        <select id="file-select"></select>
        <button id="openTenderForm">T</button>
<select id="biddersDropdown" class="toolbar-select" title="Bidders" style="display:none; width: 200px;"></select>

<button id="openABC">ABC</button>

      </div>
      <div id="pdf-container"></div>
    </section>
  </div>

  <!-- Magnifier container -->
  <div class="magnifier" id="magnifier"><canvas></canvas></div>


<!-- ‚ñë‚ñë main ‚ñë‚ñë -->

<!-- Sticky Bubble & Pad -->
<div id="stickyBubble">S</div>
<div id="stickyPad" style="display:none;">
  <!-- Top toolbar -->
  <div class="sticky-toolbar">
    <span class="drag-handle">:::</span>
    <button id="addNote">+</button>
    <button id="prevNote"><</button>
    <select id="noteHeading"></select>

    <button id="nextNote">></button>
    <button id="resetNotes">üîÑ</button>
    <button id="deleteNote">üóëÔ∏è</button>
  </div>

  <!-- Note content -->
  
<textarea id="noteText" placeholder="Write notes..."></textarea>


  <!-- Footer for copy button -->
  <div class="sticky-footer">
    <div class="note-meta">
Page No: <input type="number" id="notePageStart" style="width:25px;"> 
to <input type="number" id="notePageEnd" style="width:25px;">

    <button id="copyNote">Copy</button></div>
  </div>
</div>

</div>

<!-- ABC Popup -->
<div id="abcPopup" class="popup-overlay" style="display:none;">
  <div class="popup-content" style="max-width:600px;">
    <h2>Available Bid Capacity (ABC) (No. 07)</h2>
    <div id="abcContainer"></div>
    <div class="btn-bar">
      <button id="abcCloseBtn">Close</button>
    </div>
  </div>
</div>

<script>

  

/* ==== storage & context ================================================== */
const qs         = new URLSearchParams(location.search);
const bidderId   = qs.get('bidder') || localStorage.getItem('currentBidder') || '1';
const mainData   = JSON.parse(localStorage.getItem('mainData')  || '{}');
const biddersAll = JSON.parse(localStorage.getItem('tbidData')  || '{}');
const bidderData = biddersAll[bidderId] || {};
const nitCostNum = Number(mainData.nitCost||0);


/* ==== banner (status removed) =========================================== */
function summaryHtml(){
  return `Name of work: ${mainData.workName||'Tender'} | NIT Cost: ‚Çπ${mainData.nitCost||'‚Äî'} Lakhs | Time of Completion: ${mainData.timeCompletion||'‚Äî'} days | No. of Bidders: ${mainData.numBidders||'‚Äî'} | Tender No: ${mainData.tenderNo||'‚Äî'} | File No: ${mainData.fileNo||'‚Äî'} | Opening Date: ${mainData.dateOpTender||'‚Äî'} `;
}

document.getElementById('scrollText').innerText = summaryHtml();


/* ==== checklist ========================================================= */
const checklistItems=[
  "EMD"
  /*,
  "List of Works & Performance Certificates",
  "CA‚ÄëCertified Annual Turnover","Engineering Establishment ‚Äì Qualified Engineers",
  "VEP Ownership / Lease Proof",
  "No Blacklisting / Govt Dues / Litigation","Arbitration / Court Case Details",
  
  "DGBR Workload Capability Check","Affidavits & Declarations (Validity ‚â§¬†6‚ÄØm)",
  "Original EMD / IP delivered"*/
];
const panel=document.getElementById('checklist');

/* ==== helper for ordinary rows ========================================== */
function makeRow(txt){const r=document.createElement('div');
  r.className='item-row';
  r.innerHTML=`<input type="checkbox"><label>${txt}</label><input type="text" placeholder="Remarks">`;
  return r;
}

/* ==== create rows ======================================================= */
checklistItems.forEach((txt, idx) => {
  if (idx === 0) {
    buildABCSection();  // ‚úÖ keep only ABC section
  }
});



/* ===== Available‚ÄëBid‚ÄëCapacity (ABC) section ============================ */
function buildABCSection(){
  const panel = document.getElementById("abcContainer"); // instead of checklist
  panel.innerHTML = ""; // clear old
  const required = nitCostNum;
  const now = new Date();
  const curFY = now.getMonth() >= 3 ? now.getFullYear() : now.getFullYear() - 1;

  const fyOpts = [...Array(5)].map((_,i)=>{
      const start = curFY - i - 1;
      const end   = (start + 1).toString().slice(-2);
      return `${start}-${end}`;
  });

  const Ndays = parseFloat((mainData.timeCompletion||'').toString()) || 0;

  const box = document.createElement('div'); box.className = 'box';
  box.innerHTML = `<label>Available Bid Capacity (ABC) (No. 07)</label>`;

  const row = document.createElement('div'); row.className = 'inline';
  const sel = document.createElement('select'); sel.id = 'abcFY'; sel.style.marginRight = '10px';
  fyOpts.forEach(v => {
     const opt = document.createElement('option'); opt.value = v; opt.textContent = v;
     sel.appendChild(opt);
  });
  row.innerHTML = 'FY: ';
  row.appendChild(sel);
  row.innerHTML +=
    `A = <input type="number" id="abcA" placeholder="‚Çπ Lakhs" style="width:80px;margin-left:10px">
         B = <input type="number" id="abcB" placeholder="‚Çπ Lakhs" style="width:70px;margin-left:10px">`;
  box.appendChild(row);

  const nInfo = document.createElement('p');
  nInfo.style = 'margin:2px 0 0;font-size:.78rem';
  nInfo.textContent = `N: ${Ndays} days  (${(Ndays/365).toFixed(2)} yr)`;
  box.appendChild(nInfo);

  const res  = document.createElement('p');   res.id  = 'abcRes';  res.style = 'margin:4px 0;font-size:.78rem';
  const warn = document.createElement('div'); warn.id = 'abcWarn'; warn.className = 'warn';
  box.appendChild(res); box.appendChild(warn);

  const rk = document.createElement('div'); rk.className = 'remark-line';
  rk.innerHTML = `Remarks: <input type="text" id="abcRemark">`;
  box.appendChild(rk);

  panel.appendChild(box);

  [sel, ...row.querySelectorAll('input')].forEach(el => el.oninput = compute);
  compute();

  function compute(){
    const fyStart = parseInt(sel.value.slice(0,4),10);
    const diff = Math.max(0, Math.min(5, curFY - fyStart));
    const factor = 1 + diff * 0.10;

    const Araw = Number(document.getElementById('abcA').value || 0);
    const B    = Number(document.getElementById('abcB').value || 0);
    const ABC  = 2.5 * (Araw * factor) * (Ndays / 365) - B;

    res.textContent =
      `Adjusted A: ‚Çπ${(Araw*factor).toFixed(2)} L | ABC: ‚Çπ${ABC.toFixed(2)} L (need > ‚Çπ${required} L)`;
    warn.textContent = (ABC > required) ? '' : 'doesn‚Äôt meet ABC criteria';
  }
}
document.getElementById("openABC").onclick = () => {
  buildABCSection();
  document.getElementById("abcPopup").style.display = "flex";
};
document.getElementById("abcCloseBtn").onclick = () => {
  document.getElementById("abcPopup").style.display = "none";
  
};

/* ===== helper: gather all rows incl. custom checks ====================== */
function collectRows(){
  const rows=[];

  /* ---- EMD row --------------------------------------------------------- */
  const status=bidderData.status||'unenlisted';
  if(status==='enlisted'){
    rows.push({item:'EMD',checked:true,remark:document.getElementById('emdRemark').value||'Exempted'});
  }else if(status==='unenlisted'){
    const chk=[...document.querySelectorAll('.emdChk')];
    rows.push({
      item:'EMD',
      checked:chk.every(c=>c.checked),
      amount:document.getElementById('emdAmount')?.value||'',
      form  :document.getElementById('emdForm')?.value||'',
      uploaded:chk[0]?.checked||false,
      original:chk[1]?.checked||false,
      matched :chk[2]?.checked||false,
      remark:document.getElementById('emdRemark').value||''
    });
  }else{ // msme
    const copyVal=document.querySelector('[name=msmeCopy]:checked')?.value||'';
    const bsdVal=document.querySelector('[name=msmeBSD]:checked')?.value||'';
    rows.push({
      item:'EMD',
      checked:(copyVal==='yes'&&bsdVal==='yes'),
      msmeCopy:copyVal,
      bsdCopy:bsdVal,
      remark:document.getElementById('emdRemark').value||''
    });
  }

  /* ---- Integrity Pact (if any) ---------------------------------------- */
  if(nitCostNum>500){
    const ipVal=document.querySelector('[name=ipYesNo]:checked')?.value||'';
    const ipChk=[...document.querySelectorAll('.ipChk')];
    rows.push({
      item:'Integrity Pact',
      required:true,
      yesNo:ipVal,
      uploaded:ipChk[0]?.checked||false,
      original:ipChk[1]?.checked||false,
      matched:ipChk[2]?.checked||false,
      checked:(ipVal==='yes' && ipChk.every(c=>c.checked)),
      remark:document.getElementById('ipRemark').value||''
    });
  }

  // Experience Criteria
// Experience Criteria
const expRow = {
  item: 'Experience Criteria',
  checked: document.getElementById('expMain')?.checked || false,
  mode: document.querySelector('input[name="expMode"]:checked')?.value || '',
  listSubmitted: document.querySelectorAll('.expChk')[0]?.checked || false,
  certSubmitted: document.querySelectorAll('.expChk')[1]?.checked || false,
  valueMeets: document.querySelectorAll('.expChk')[2]?.checked || false,
  remark: document.getElementById('expRemark')?.value || '',
  entries: []
};

const count = expRow.mode === '3x40' ? 3 : expRow.mode === '2x50' ? 2 : expRow.mode === '1x80' ? 1 : 0;

for (let i = 1; i <= count; i++) {
  expRow.entries.push({
    name:    document.getElementById(`expWorkName${i}`)?.value || '',
    scope:   document.getElementById(`expScope${i}`)?.value || '',
    client:  document.getElementById(`expClient${i}`)?.value || '',
    amount:  document.getElementById(`expAmount${i}`)?.value || '',
    start:   document.getElementById(`expCommence${i}`)?.value || '',
    orig:    document.getElementById(`expOrigComp${i}`)?.value || '',
    ext:     document.getElementById(`expExtComp${i}`)?.value || '',
    actual:  document.getElementById(`expActual${i}`)?.value || '',
    cost:    document.getElementById(`expCost${i}`)?.value || '',
    notes:   document.getElementById(`expNotes${i}`)?.value || ''
  });
}

expRow.valid = expRow.checked && expRow.listSubmitted && expRow.certSubmitted && expRow.valueMeets;
rows.push(expRow);



  /* ---- generic items --------------------------------------------------- */
  [...panel.querySelectorAll('.item-row')]
   .forEach(r=>{
     const [chk,lbl,inp]=r.children;
     rows.push({item:lbl.textContent.trim(),checked:chk.checked,remark:inp.value});
   });

  return rows;
}


let flagCounter = 0;
function newFlagId() { return 'f' + (++flagCounter); }
function renumberFlags() {
  // reset counter
  flagCounter = 0;

  // flatten all flags from all docs in the order they were added
  const allFlags = docs.flatMap(doc => doc.flags);

  allFlags.forEach(f => {
    flagCounter++;
    f.label = String(flagCounter);
  });

  // üîπ Re-render flags for the current visible doc
  if (current) {
    // Remove old DOM flags
    document.querySelectorAll('.flag').forEach(el => el.remove());

    // Recreate flags with updated labels
    current.flags.forEach(f => {
      const wrapper = pagesWrapper.querySelector(
        `.single-page-wrapper[data-page-index="${f.pageIndex}"]`
      );
      if (wrapper) {
        createFlagElement(wrapper, f);
      }
    });
  }
}






function createFlagElement(wrapper, { id, name, label }) {
  const flag = document.createElement('div');
  flag.className = 'flag';
  flag.dataset.flagId = id;
  flag.dataset.flagName = name;
  flag.dataset.flagText = label;
  flag.textContent = label;
  flag.title = `${name}${label ? ': ' + label : ''}`;
  flag.style.cssText = 'position:absolute;top:6px;right:6px';
  makeFlagEditable(flag);
  wrapper.appendChild(flag);
}

function makeFlagEditable(flag) {
  flag.ondblclick = () => {
    const newLabel = prompt('Rename flag label:', flag.textContent);
    if (!newLabel) return;
    flag.textContent = newLabel;
    flag.dataset.flagText = newLabel;
    flag.title = `${flag.dataset.flagName}${newLabel ? ': ' + newLabel : ''}`;
    
    // Update in flags array if needed
    const entry = current?.flags?.find(f => f.id === flag.dataset.flagId);
    if (entry) entry.label = newLabel;
  };
}

    /*****************************************
     * 1. Globals & helpers                  *
     *****************************************/
    pdfjsLib.GlobalWorkerOptions.workerSrc =
      'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.worker.min.js';

    const pdfContainer = document.getElementById('pdf-container');

    /* ---- inner holder that receives the transforms (scale + rotate) ---- */
    const pagesWrapper = document.createElement('div');
    pagesWrapper.id = 'pages-wrapper';
    pagesWrapper.style.transformOrigin = 'top left';
    pdfContainer.appendChild(pagesWrapper);

    const fileInput = document.getElementById('file-input');

    /* viewer state */
    const docs = [];           // [{name, bytes, pdfDoc, flags:[]}, ‚Ä¶]
    let   current = null;      // pointer to current docs[index]
    let   zoom     = 1;

    /* undo / redo */
    const actionStack = [], redoStack = [];
    let   selectedFlag = null;
    const selectedPages = new Set();   // pages ticked with the little checkbox

    /* Magnifier state */
    const magnifier = document.getElementById('magnifier');
    const magnifierCanvas = magnifier.querySelector('canvas');
    let magnifierEnabled = false;
    let ctrlPressed = false;
    let magnifierZoom = 2;
    let magnifierWidth = 150;
    let magnifierHeight = 75;

    // Initialize magnifier
    magnifier.style.width = `${magnifierWidth}px`;
    magnifier.style.height = `${magnifierHeight}px`;
    magnifier.style.display = 'none';

    function registerAction(el, parent) {
      actionStack.push({ el, parent });
      redoStack.length = 0;
    }

    document.getElementById('undo-btn').onclick = () => {
      const last = actionStack.pop();
      if (last) {
        last.el.remove();
        redoStack.push(last);
      }
    };

    document.getElementById('redo-btn').onclick = () => {
      const last = redoStack.pop();
      if (last) {
        last.parent.appendChild(last.el);
        actionStack.push(last);
      }
    };




    /* Magnifier controls */
    document.getElementById('zoomRange').addEventListener('input', (e) => {
      magnifierZoom = parseFloat(e.target.value);
    });

    document.getElementById('radiusRange').addEventListener('input', (e) => {
      magnifierWidth = parseInt(e.target.value);
      magnifierHeight = Math.floor(magnifierWidth / 2);
      magnifier.style.width = `${magnifierWidth}px`;
      magnifier.style.height = `${magnifierHeight}px`;
    });

    document.getElementById('toggleMagnifier').onclick = () => {
      magnifierEnabled = !magnifierEnabled;
      magnifier.style.display = magnifierEnabled ? 'block' : 'none';
      currentTool = magnifierEnabled ? 'magnifier' : null;
    };

    

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Control') ctrlPressed = true;
    });

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Control') ctrlPressed = true;
      if (e.key === 'Escape') { // Add escape key handler
        magnifierEnabled = false;
        magnifier.style.display = 'none';
        currentTool = null;
        document.querySelectorAll('#toolbar button[data-tool]').forEach(b => b.classList.remove('active'));
      }
    });
    
    document.addEventListener('keyup', (e) => {
      if (e.key === 'Control') ctrlPressed = false;
    });

    /* --- Copy Flags (metadata version) --- */
    document.getElementById('copy-flags').onclick = () => {
      const rows = docs.flatMap(doc =>
        doc.flags.map(f => `${doc.name}\t${f.name}\t${f.label}`)
      );

      if (!rows.length) {
        alert('No flags to copy.');
        return;
      }

      const out = 'File\tFlag Name\tPage No\n' + rows.join('\n');
      navigator.clipboard.writeText(out)
        .then(() => alert('Copied! Paste into Excel or Sheets.'));
    };

    function populateSelect () {
      const sel = document.getElementById('file-select');
      sel.innerHTML = docs.map((d, i) =>
        `<option value="${i}">${d.name}</option>`).join('');
    }
    document.getElementById('file-select').onchange = e =>
      changeDoc(+e.target.value);

    async function changeDoc (index) {
      current = docs[index];
      zoom = 1;
      renderAllPages();
      document.getElementById('file-select').value = index;
    }

    /* zoom buttons */
    document.getElementById('zoom-in').onclick  = () => { zoom *= 1.2; applyZoom(); };
    document.getElementById('zoom-out').onclick = () => { zoom /= 1.2; applyZoom(); };

    /* ---------- per-page rotation ---------- */
    function getVisiblePage () {
  const midY = pdfContainer.scrollTop + pdfContainer.clientHeight / 2;
  let best = null, bestGap = Infinity;
  pagesWrapper.querySelectorAll('.single-page-wrapper, .two-page-wrapper').forEach(w => {
    const mid = w.offsetTop + w.offsetHeight / 2;
    const gap = Math.abs(mid - midY);
    if (gap < bestGap) { bestGap = gap; best = w; }
  });
  return best;
}



  
    function rotateVisiblePage(delta) {
  const page = getVisiblePage();
  if (!page) return;
  
  // Find the parent two-page wrapper if exists
  const container = page.closest('.two-page-wrapper') || page;
  
  let angle = +(container.dataset.rotate || 0);
  angle = (angle + delta + 360) % 360;
  container.dataset.rotate = angle;
  container.style.transformOrigin = 'center center';
  container.style.transform = `rotate(${angle}deg)`;
}

    document.getElementById('rotate-left').onclick  = () => rotateVisiblePage(-90);
    document.getElementById('rotate-right').onclick = () => rotateVisiblePage(90);

    /* ---------- unified transform helper ---------- */
    function applyZoom() {
  pagesWrapper.style.transform = `translateX(-50%) scale(${zoom})`;
}
    /*****************************************
     * Magnifier Functions                   *
     *****************************************/
  let targetX = 0, targetY = 0;
let currentX = 0, currentY = 0;
let animating = false;

function handleMagnifierMove(e) {
  const overlay = e.currentTarget;
  const canvas = overlay.previousElementSibling;
  if (!canvas || canvas.width === 0 || canvas.height === 0) return;

  const rect = canvas.getBoundingClientRect();
  const x = e.clientX - rect.left;
  const y = e.clientY - rect.top;

  targetX = e.pageX - magnifierWidth / 2;
  targetY = e.pageY - magnifierHeight / 2;

  magnifier.style.width = `${magnifierWidth}px`;
  magnifier.style.height = `${magnifierHeight}px`;

  magnifier.style.backgroundImage = `url(${canvas.toDataURL()})`;
  magnifier.style.backgroundSize = `${canvas.width * magnifierZoom}px ${canvas.height * magnifierZoom}px`;
  magnifier.style.backgroundPosition = `-${x * magnifierZoom - magnifierWidth / 2}px -${y * magnifierZoom - magnifierHeight / 2}px`;

  if (!animating) animateMagnifier();
}

function animateMagnifier() {
  animating = true;

  const smoothSpeed = 0.15; // Adjust for faster/slower motion

  function step() {
    const dx = targetX - currentX;
    const dy = targetY - currentY;

    currentX += dx * smoothSpeed;
    currentY += dy * smoothSpeed;

    magnifier.style.left = `${currentX}px`;
    magnifier.style.top = `${currentY}px`;

    if (Math.abs(dx) > 0.5 || Math.abs(dy) > 0.5) {
      requestAnimationFrame(step);
    } else {
      animating = false;
    }
  }

  requestAnimationFrame(step);
}


    /*****************************************
     * 3. PDF Rendering                      *
     *****************************************/
    fileInput.addEventListener('change', async e => {
      for (const file of e.target.files) {
        const bytes  = await file.arrayBuffer();
        const pdfDoc = await pdfjsLib.getDocument({data: bytes}).promise;
        docs.push({ name: file.name, bytes, pdfDoc, flags: [] });
      }
      populateSelect();
      if (!current) changeDoc(0);
    });


    function calculateScale(viewportWidth) {
  const containerWidth = pdfContainer.clientWidth;
  // Scale to fit width with some padding (90% of container width)
  return (containerWidth * 0.9) / viewportWidth;
}
async function renderAllPages() {
  pagesWrapper.innerHTML = '';
  current.pageCanvases = [];
  
  // Calculate container width for proper scaling
  const containerWidth = pdfContainer.clientWidth;
  const pagePairWidth = (containerWidth * 0.9) - 20; // 90% width minus gap

  // Render pages in pairs
  for (let i = 1; i <= current.pdfDoc.numPages; i += 2) {
    // Create container for two pages
    const pairWrapper = document.createElement('div');
    pairWrapper.className = 'two-page-wrapper';
    
    // First page
    const page1 = await renderSinglePage(i, pagePairWidth / 2);
    if (page1) pairWrapper.appendChild(page1);
    
    // Second page (if exists)
    if (i + 1 <= current.pdfDoc.numPages) {
      const page2 = await renderSinglePage(i + 1, pagePairWidth / 2);
      if (page2) pairWrapper.appendChild(page2);
    }
    
    pagesWrapper.appendChild(pairWrapper);
  }
  
  applyZoom();
}

async function renderSinglePage(pageNum, targetWidth) {
  try {
    const page = await current.pdfDoc.getPage(pageNum);
    const viewport = page.getViewport({ scale: 1.0 });
    
    // Calculate scale to fit target width
    const scale = targetWidth / viewport.width;
    const scaledViewport = page.getViewport({ scale });
    
    const wrapper = document.createElement('div');
    wrapper.className = 'single-page-wrapper';
    wrapper.dataset.pageIndex = pageNum - 1;
    wrapper.style.width = `${scaledViewport.width}px`;
    wrapper.style.height = `${scaledViewport.height}px`;
    
    const canvas = document.createElement('canvas');
    canvas.className = 'page-canvas';
    canvas.width = scaledViewport.width;
    canvas.height = scaledViewport.height;
    
    const overlay = document.createElement('div');
    overlay.className = 'overlay';
    
    const picker = document.createElement('input');
    picker.type = 'checkbox';
    picker.className = 'page-select';
    picker.style.cssText = 'position:absolute;top:6px;left:6px;transform:scale(1.2)';
    picker.onchange = () => {
      if (picker.checked) selectedPages.add(wrapper);
      else selectedPages.delete(wrapper);
    };

    wrapper.append(canvas, overlay, picker);
    
    // Render the page
    await page.render({
      canvasContext: canvas.getContext('2d'),
      viewport: scaledViewport
    }).promise;
    
    // Restore any saved flags for this page
    const saved = current.flags.filter(f => f.pageIndex === pageNum - 1);
    saved.forEach(f => createFlagElement(wrapper, f));
    
    attachOverlayEvents(overlay, wrapper);
    current.pageCanvases.push(canvas);
    
    return wrapper;
  } catch (error) {
    console.error(`Error rendering page ${pageNum}:`, error);
    return null;
  }
}

    /*****************************************
     * 4. Toolbar state                      *
     *****************************************/
    let currentTool=null;
   document.querySelectorAll('#toolbar button[data-tool]').forEach(btn =>
  btn.addEventListener('click', () => {
    if (currentTool === btn.dataset.tool) {
      // üîπ If already active, turn it OFF
      btn.classList.remove('active');
      currentTool = null;
      magnifierEnabled = false;
      magnifier.style.display = 'none';
    } else {
      // üîπ Otherwise activate it
      document.querySelectorAll('#toolbar button[data-tool]').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      currentTool = btn.dataset.tool;
      magnifierEnabled = currentTool === 'magnifier';
      magnifier.style.display = magnifierEnabled ? 'block' : 'none';
    }
  })
);


document.getElementById('remove-flag').onclick = () => {
  if (!selectedFlag) return alert('Select a flag first');

  const id = selectedFlag.dataset.flagId;
  current.flags = current.flags.filter(f => f.id !== id);

  registerAction(selectedFlag, selectedFlag.parentElement);
  selectedFlag.remove();
  selectedFlag = null;

  renumberFlags();   // üîπ added here
};


    /*****************************************
     * 5. Overlay Interaction                *
     *****************************************/
    function overlayCoords(ev,overlay){ const r=overlay.getBoundingClientRect(); return {x:(ev.clientX-r.left)/zoom, y:(ev.clientY-r.top)/zoom}; }
    function attachOverlayEvents(overlay,wrapper){
      let drawing=false,startX,startY,activeEl,isMovingText=false,movedText;
      let freeCanvas,freeCtx,isFree=false;

      freeCanvas=document.createElement('canvas');
      freeCanvas.className='freehand';
      freeCanvas.style.cssText='position:absolute;top:0;left:0;';
      freeCanvas.width=overlay.offsetWidth;
      freeCanvas.height=overlay.offsetHeight;
      overlay.appendChild(freeCanvas);
      freeCtx=freeCanvas.getContext('2d');
      freeCtx.lineWidth=2;
      freeCtx.strokeStyle='blue';
      freeCtx.lineCap='round';

      wrapper.addEventListener('click',e=>{
        if(currentTool==='flag' || e.target.classList.contains('flag')){
          if(selectedFlag){
            selectedFlag.style.transform='';
            selectedFlag.style.boxShadow='';
          }
          if(e.target.classList.contains('flag')){
            selectedFlag=e.target;
            selectedFlag.style.transform='scale(1.12)';
            selectedFlag.style.boxShadow='0 0 7px rgba(0,0,0,.5)'; 
            e.stopPropagation();
          }
        }
      });

       // Add these mouse enter/leave handlers
       overlay.addEventListener('mouseenter', () => {
        if (magnifierEnabled) magnifier.style.display = 'block';
      });
      
      overlay.addEventListener('mouseleave', () => {
        magnifier.style.display = 'none';
      });

      overlay.addEventListener('mousedown',e=>{
        if(['rect','highlight'].includes(currentTool)){
          drawing=true; 
          const {x,y}=overlayCoords(e,overlay); 
          startX=x; startY=y; 
          activeEl=document.createElement('div'); 
          activeEl.className=currentTool==='rect'?'rect':'highlight'; 
          activeEl.style.left=x+'px'; 
          activeEl.style.top=y+'px'; 
          overlay.appendChild(activeEl);
        } 
        
        else if(currentTool==='text'){ 
          const el=document.elementFromPoint(e.clientX,e.clientY); 
          if(el&&el.classList.contains('text-annotation')){ 
            isMovingText=true; 
            movedText=el; 
            movedText.style.opacity='.7'; 
            movedText.style.zIndex='1000'; 
          } 
        }
      });

      overlay.addEventListener('mousemove',e=>{
        if (magnifierEnabled && !isMovingText && !drawing && !isFree) {
          handleMagnifierMove(e);
          magnifier.style.display = 'block'; // Ensure visible when moving over PDF
        }
        else if(isFree){ 
          const {x,y}=overlayCoords(e,overlay); 
          freeCtx.lineTo(x,y); 
          freeCtx.stroke(); 
        }
        else if(isMovingText){ 
  movedText.style.left = `${e.pageX - pdfContainer.offsetLeft - magnifierWidth / 2}px`;
  movedText.style.top = `${e.pageY - pdfContainer.offsetTop - magnifierHeight / 2}px`;
}

        else if(drawing&&activeEl){ 
          const {x,y}=overlayCoords(e,overlay); 
          const w=x-startX,h=y-startY; 
          activeEl.style.width=Math.abs(w)+'px'; 
          activeEl.style.height=Math.abs(h)+'px'; 
          activeEl.style.left=(w<0?x:startX)+'px'; 
          activeEl.style.top=(h<0?y:startY)+'px'; 
        }
      });

      ['mouseup','mouseleave'].forEach(evt=>overlay.addEventListener(evt,()=>{
        if(drawing&&activeEl){ registerAction(activeEl,overlay); }
        else if(isFree){ 
          const perm=document.createElement('canvas');
          perm.className='freehand';
          perm.style.cssText='position:absolute;top:0;left:0;';
          perm.width=freeCanvas.width;
          perm.height=freeCanvas.height;
          perm.getContext('2d').drawImage(freeCanvas,0,0); 
          overlay.appendChild(perm); 
          registerAction(perm,overlay); 
          freeCtx.clearRect(0,0,freeCanvas.width,freeCanvas.height); 
        }
        else if(isMovingText){ 
          isMovingText=false; 
          movedText.style.opacity=''; 
          movedText.style.zIndex=''; 
          registerAction(movedText,overlay); 
          movedText=null; 
        }
        drawing=false; isFree=false; activeEl=null;
      }));

      overlay.addEventListener('click',e=>{
        if(currentTool==='text'&&!isMovingText){ 
          const txt=prompt('Text:'); 
          if(!txt) return; 
          const {x,y}=overlayCoords(e,overlay); 
          const note=document.createElement('div'); 
          note.className='text-annotation'; 
          note.textContent=txt; 
          note.style.left=x+'px'; 
          note.style.top=y+'px'; 
          overlay.appendChild(note); 
          registerAction(note,overlay); 
        }
else if (currentTool === 'flag') {
  const pageIndex = +wrapper.dataset.pageIndex;

  // üîπ Prevent more than one flag on the same page
  const alreadyFlagged = current.flags.some(f => f.pageIndex === pageIndex);
  if (alreadyFlagged) {
    alert("This page has already been flagged!");
    return;
  }

  let name;
  if (e.ctrlKey) {
    name = "Flag";   // default for Ctrl+click
  } else {
    name = prompt('Flag name?');
    if (name === null) return;
  }

  const id = newFlagId();
  const label = ""; // temporary placeholder

  const flag = document.createElement('div');
  flag.className = 'flag';
  flag.textContent = label;
  flag.style.top = '6px';
  flag.style.right = '6px';
  flag.dataset.flagId = id;
  flag.dataset.flagName = name;
  flag.dataset.flagText = label;
  flag.title = `${name}`;
  makeFlagEditable(flag);
  wrapper.appendChild(flag);

  registerAction(flag, wrapper);
  current.flags.push({ id, pageIndex, name, label });

  renumberFlags();   // üîπ always refresh numbering
}


      });
    }

    /*****************************************
     * 6. Download flagged pages (all PDFs)  *
     *****************************************/
    async function downloadFlaggedPages() {
      if (!docs.length) { alert('Load PDFs first'); return; }

      const all = docs.flatMap((d, di) =>
        d.flags.map(meta => ({ meta, docIndex: di }))
      );
      if (!all.length) { alert('No flagged pages'); return; }

     //all.sort((a, b) => Number(a.meta.label) - Number(b.meta.label));

      const { PDFDocument, rgb, StandardFonts } = PDFLib;
      const out  = await PDFDocument.create();
      const font = await out.embedFont(StandardFonts.Helvetica);

      for (const { meta, docIndex } of all) {
        const doc      = docs[docIndex];
        const orig     = await PDFDocument.load(doc.bytes);
        const pageNum  = meta.pageIndex;
        const [page]   = await out.copyPages(orig, [pageNum]);
        out.addPage(page);

        const pW = page.getWidth(), pH = page.getHeight();
        const margin = 6;
        const size   = 14;

        const label  = meta.label;
        const textW  = font.widthOfTextAtSize(label, size);

        const x = pW - margin - textW;
        const y = pH - margin - size;

        page.drawText(label, { x, y, size, font, color: rgb(1, 0, 0) });
      }

      const bytes = await out.save();
      const blob  = new Blob([bytes], { type: 'application/pdf' });
      const url   = URL.createObjectURL(blob);
      const a     = document.createElement('a');
      a.href = url;
      a.download = 'flagged_combined.pdf';
      a.click();
      URL.revokeObjectURL(url);
    }

// Make sticky bubble draggable 
(function(){ 
  const bubble = document.getElementById('stickyBubble');
  let offsetX=0, offsetY=0, isDrag=false;

  bubble.addEventListener('mousedown',e=>{
    isDrag=true;
    offsetX=e.clientX-bubble.offsetLeft;
    offsetY=e.clientY-bubble.offsetTop;
  });
  document.addEventListener('mousemove',e=>{
    if(!isDrag)return;
    bubble.style.left=(e.clientX-offsetX)+'px';
    bubble.style.top=(e.clientY-offsetY)+'px';
    bubble.style.position='fixed';
  });
  document.addEventListener('mouseup',()=>{isDrag=false;});
  bubble.addEventListener('click',()=>{
    const pad=document.getElementById('stickyPad');
    pad.style.display=pad.style.display==='flex'?'none':'flex';
  });
})();

const stickyPad   = document.getElementById("stickyPad");
const noteText    = document.getElementById("noteText");
const notePage    = document.getElementById("notePage");
const noteHeading = document.getElementById("noteHeading"); // now a <select>

let notes = [];
let currentIndex = 0;

// -------- STORAGE --------
function saveNotes() {
  localStorage.setItem("stickyNotes", JSON.stringify(notes));
}

function loadNotes() {
  const saved = localStorage.getItem("stickyNotes");
  if (saved) {
    notes = JSON.parse(saved);
  } else {
    notes = [{ page: "", text: "" }];
  }
}

// -------- UI HELPERS --------
function updateNoteDropdown() {
  noteHeading.innerHTML = "";
  notes.forEach((_, i) => {
    const opt = document.createElement("option");
    opt.value = i;
    opt.textContent = "Note " + (i + 1);
    if (i === currentIndex) opt.selected = true;
    noteHeading.appendChild(opt);
  });
}

function loadNote() {
  const note = notes[currentIndex] || { pageStart: "", pageEnd: "", text: "" };
  document.getElementById("notePageStart").value = note.pageStart || "";
  document.getElementById("notePageEnd").value = note.pageEnd || "";
  noteText.value = note.text || "";
  updateNoteDropdown();
}


function saveCurrentNote() {
notes[currentIndex] = {
  pageStart: document.getElementById("notePageStart").value,
  pageEnd: document.getElementById("notePageEnd").value,
  text: noteText.value
};

  saveNotes();
}

// -------- EVENTS --------
document.getElementById("addNote").onclick = () => {
  saveCurrentNote();
  notes.push({ page: "", text: "" });
  currentIndex = notes.length - 1;
  loadNote();
  saveNotes();
};

document.getElementById("prevNote").onclick = () => {
  saveCurrentNote();
  if (currentIndex > 0) {
    currentIndex--;
    loadNote();
  } else {
    alert("This is the first note.");
  }
};

document.getElementById("nextNote").onclick = () => {
  saveCurrentNote();
  if (currentIndex < notes.length - 1) {
    currentIndex++;
    loadNote();
  } else {
    alert("This is the last note.");
  }
};

document.getElementById("resetNotes").onclick = () => {
  if (confirm("Clear this note?")) {
    notes[currentIndex] = { page: "", text: "" };  
    notePage.value = "";
    noteText.value = "";
    saveNotes();
    updateNoteDropdown();
  }
};

document.getElementById("deleteNote").onclick = () => {
  if (confirm("Delete this note?")) {
    notes.splice(currentIndex, 1);
    if (notes.length === 0) {
      notes = [{ page: "", text: "" }];
      currentIndex = 0;
    } else if (currentIndex >= notes.length) {
      currentIndex = notes.length - 1;
    }
    loadNote();
    saveNotes();
  }
};

document.getElementById("copyNote").onclick = () => {

// Sync inputs back into notes before copying
document.querySelectorAll(".note").forEach((noteDiv, i) => {
  const startInput = noteDiv.querySelector(".notePageStart");
  const endInput = noteDiv.querySelector(".notePageEnd");
  notes[i].pageStart = startInput.value.trim();
  notes[i].pageEnd = endInput.value.trim();
  notes[i].text = noteDiv.querySelector("textarea").value.trim();
});

  if (!notes || notes.length === 0) {
    alert("No notes to copy.");
    return;
  }

  // Tender No & Bidder
  const mainData = JSON.parse(localStorage.getItem("mainData") || "{}");
  const tenderNo = mainData.tenderNo || "‚Äî";
  const biddersDropdown = document.getElementById("biddersDropdown");
  const bidderName = biddersDropdown?.options[biddersDropdown.selectedIndex]?.text || "‚Äî";

  // --- Plain text version ---
  let plainOutput = `Tender No: ${tenderNo}\nBidder: ${bidderName}\n\n`;
  plainOutput += notes.map((note, i) => {
    let pageLabel = "";
    if (note.pageStart && note.pageEnd) {
      pageLabel = ` (Page ${note.pageStart} to ${note.pageEnd})`;
    } else if (note.pageStart) {
      pageLabel = ` (Page ${note.pageStart})`;
    } else if (note.pageEnd) {
      pageLabel = ` (Page ${note.pageEnd})`;
    }
    return `Note ${i + 1}${pageLabel}:\n${note.text}\n`;
  }).join("\n");

  // --- HTML version ---
  let htmlOutput = `<b>Tender No:</b> ${tenderNo}<br><b>Bidder:</b> ${bidderName}<br><br>`;
  htmlOutput += notes.map((note, i) => {
    let pageLabel = "";
    if (note.pageStart && note.pageEnd) {
      pageLabel = ` (Page ${note.pageStart} to ${note.pageEnd})`;
    } else if (note.pageStart) {
      pageLabel = ` (Page ${note.pageStart})`;
    } else if (note.pageEnd) {
      pageLabel = ` (Page ${note.pageEnd})`;
    }
    return `<b>Note ${i + 1}${pageLabel}:</b><br>${note.text.replace(/\n/g,"<br>")}<br><br>`;
  }).join("");

  // --- Copy both plain + rich text ---
  navigator.clipboard.write([
    new ClipboardItem({
      "text/plain": new Blob([plainOutput], { type: "text/plain" }),
      "text/html": new Blob([htmlOutput], { type: "text/html" })
    })
  ]).then(() => {
    alert("Notes copied with Tender No & Bidder!");
  }).catch(err => {
    console.error("Copy failed", err);
    alert("Copy failed. Check browser permissions.");
  });
};




noteText.oninput = () => {
  notes[currentIndex].text = noteText.value;
  saveNotes();
};
document.getElementById("notePageStart").oninput =
document.getElementById("notePageEnd").oninput = () => {
  saveCurrentNote();  // already saves to localStorage
};


noteHeading.onchange = (e) => {
  saveCurrentNote();
  currentIndex = parseInt(e.target.value, 10);
  loadNote();
};




// -------- INIT --------
loadNotes();
if (notes.length) loadNote();

// Open/Close Popup
document.getElementById('openTenderForm').onclick = () => {
  loadTenderForm();
  const tenderPopup = document.getElementById('tenderPopup');
  tenderPopup.style.display = 'flex';

  // ‚úÖ Always show Cancel when user opens manually
  const cancelBtn = document.getElementById('popup-cancelBtn');
  if (cancelBtn) cancelBtn.style.display = 'inline-block';
};

document.getElementById('popup-cancelBtn').onclick = () => {
  document.getElementById('tenderPopup').style.display = 'none';
};

// Load saved data into popup
function loadTenderForm(){
  const data = JSON.parse(localStorage.getItem('mainData')||'{}');
  document.getElementById('popup-work-name').value = data.workName || '';
  document.getElementById('popup-nit-cost').value = data.nitCost || '';
  document.getElementById('popup-tender-no').value = data.tenderNo || '';
  document.getElementById('popup-file-no').value = data.fileNo || '';
  document.getElementById('popup-tender-date').value = data.dateOpTender || '';
  document.getElementById('popup-bidders').value = data.numBidders || '';
  document.getElementById('popup-completion-time').value = data.timeCompletion || '';
   lockPopupForm(false);  // ‚úÖ keeps inputs editable

}




// Lock/unlock inputs
function lockPopupForm(lock){
  const inputs = document.querySelectorAll('#tenderPopup input');
  inputs.forEach(i => i.disabled = lock);
  
}

</script>


<!-- Tender Form Popup -->
<div id="tenderPopup" class="popup-overlay" style="display:none;">
  <div class="popup-content">
    <h2>Tender Details</h2>

    <div class="popup-grid">
      <div class="form-group full-width">
        <label for="popup-work-name">Name of Work</label>
        <input type="text" id="popup-work-name">
      </div>
      <div class="form-group">
        <label for="popup-nit-cost">NIT Cost (in Lakhs ‚Çπ)</label>
        <input type="number" id="popup-nit-cost">
      </div>
      <div class="form-group">
        <label for="popup-tender-no">Tender No.</label>
        <input type="text" id="popup-tender-no">
      </div>
      <div class="form-group">
        <label for="popup-file-no">File No.</label>
        <input type="text" id="popup-file-no">
      </div>
      <div class="form-group">
        <label for="popup-tender-date">Date of OP of Tender</label>
        <input type="date" id="popup-tender-date">
      </div>
      <div class="form-group">
        <label for="popup-bidders">No. of Bidders</label>
        <input type="number" id="popup-bidders">
      </div>
      <div class="form-group">
        <label for="popup-completion-time">Time of Completion (Days)</label>
        <input type="number" id="popup-completion-time">
      </div>
    </div>

    <div class="btn-bar">
           
      <button id="popup-nextBtn">Next</button>
      <button id="popup-cancelBtn">Cancel</button>
    </div>
  </div>
</div>

<!-- Bidders Popup -->
<div id="biddersPopup" class="popup-overlay" style="display:none;">
  <div class="popup-content" style="width:700px;">
    <h2>Bidder Details</h2>

    <table id="biddersTable">
      <thead>
        <tr style="background:#f2f2f2;">
          <th style="padding:8px;">Srl No</th>
          <th style="padding:8px;">Bidder Name, Address</th>
          <th style="padding:8px;">Bidder No</th>
        </tr>
      </thead>
      <tbody>
        <!-- rows will be generated dynamically -->
      </tbody>
    </table>

    <div class="btn-bar">
      <button id="popup-backBtn">Back</button>
      <button id="popup-continueBtn">Continue</button>
      <button id="popup-biddersCancelBtn">Cancel</button>
    </div>
  </div>
</div>


<script>
  // üîπ Popup logic here
 function lockPopupForm(lock){
    const inputs = document.querySelectorAll('#tenderPopup input');
    inputs.forEach(i => i.disabled = lock);
  }

  function loadTenderForm(){
    const data = JSON.parse(localStorage.getItem('mainData')||'{}');
    document.getElementById('popup-work-name').value = data.workName || '';
    document.getElementById('popup-nit-cost').value = data.nitCost || '';
    document.getElementById('popup-tender-no').value = data.tenderNo || '';
    document.getElementById('popup-file-no').value = data.fileNo || '';
    document.getElementById('popup-tender-date').value = data.dateOpTender || '';
    document.getElementById('popup-bidders').value = data.numBidders || '';
    document.getElementById('popup-completion-time').value = data.timeCompletion || '';

    lockPopupForm(false); // always editable
  }

  // Open popup
  document.getElementById('openTenderForm').onclick = () => {
    loadTenderForm();
    document.getElementById('tenderPopup').style.display = 'flex';
  };

  // Cancel button
  document.getElementById('popup-cancelBtn').onclick = () => {
    document.getElementById('tenderPopup').style.display = 'none';
  };

   


function openBiddersPopup(num){
  const tbody = document.querySelector('#biddersTable tbody');
  tbody.innerHTML = ''; // clear old rows

  for (let i=1; i<=num; i++){
    const row = document.createElement('tr');
    row.innerHTML = `
  <td>${i}</td>
  <td><input type="text" id="bidder-name-${i}" placeholder="Enter name"></td>
  <td><input type="text" id="bidder-no-${i}" placeholder="Enter number"></td>
`;

    tbody.appendChild(row);
  }

  document.getElementById('biddersPopup').style.display = 'flex';
}

// Back button (go back to Tender Popup)
document.getElementById('popup-backBtn').onclick = () => {
  document.getElementById('biddersPopup').style.display = 'none';
  document.getElementById('tenderPopup').style.display = 'flex';
};

// Cancel button (close bidders popup)
document.getElementById('popup-biddersCancelBtn').onclick = () => {
  document.getElementById('biddersPopup').style.display = 'none';
};

// Continue button (save bidders and move on)
document.getElementById('popup-continueBtn').onclick = () => {
  const n = parseInt(localStorage.getItem('numBidders') || '0', 10);
  const bidders = [];
  for (let i=1; i<=n; i++){
    bidders.push({
      name: document.getElementById(`bidder-name-${i}`).value.trim(),
      no: document.getElementById(`bidder-no-${i}`).value.trim()
    });
  }

  // Save for persistence
  localStorage.setItem('bidders', JSON.stringify(bidders));

  // ‚úÖ Populate toolbar dropdown
  populateBiddersDropdown(bidders);

  // Close bidders popup
  document.getElementById('biddersPopup').style.display = 'none';
};

function populateBiddersDropdown(bidders){
  const dropdown = document.getElementById('biddersDropdown');
  if (!dropdown) return;

  dropdown.innerHTML = ''; // clear old options
  const placeholder = document.createElement('option');
  placeholder.value = '';
  placeholder.textContent = 'Select bidder‚Ä¶';
  dropdown.appendChild(placeholder);

  bidders.forEach((b, i) => {
    if (b.name) {
      const opt = document.createElement('option');
      opt.value = b.no || `bidder${i+1}`;
      opt.textContent = b.name;
      dropdown.appendChild(opt);
    }
  });

  dropdown.style.display = bidders.length ? 'inline-block' : 'none';
}


document.getElementById("biddersDropdown").addEventListener("change", (e) => {
  // Only warn if there are PDFs loaded
  if (docs.length > 0) {
    if (!confirm("Are you sure? All uploaded PDFs will be removed.")) {
      // ‚ùå User canceled ‚Üí revert dropdown back to previous value
      e.target.value = e.target.getAttribute("data-prev") || "";
      return;
    }
  }

  // ‚úÖ Clear everything
  pagesWrapper.innerHTML = "";

  // Reset global PDF state
  docs.length = 0;
  current = null;
  zoom = 1;

  // Reset file select dropdown
  const fileSelect = document.getElementById("file-select");
  if (fileSelect) fileSelect.innerHTML = "";

  // Reset file input element
  const fileInput = document.getElementById("file-input");
  if (fileInput) fileInput.value = "";

  console.log("All PDFs and file input cleared. Ready for new uploads.");

  // Save current value as last confirmed value
  e.target.setAttribute("data-prev", e.target.value);
});

// Restore dropdown on page load
window.addEventListener("DOMContentLoaded", () => {
  const saved = JSON.parse(localStorage.getItem("bidders") || "[]");
  if (saved.length) populateBiddersDropdown(saved);

  // Initialize "previous value" for confirm rollback
  const dropdown = document.getElementById("biddersDropdown");
  if (dropdown) dropdown.setAttribute("data-prev", dropdown.value);
});





  // Next button
 // Next button (from Tender Details -> open Bidders Popup)
document.getElementById('popup-nextBtn').onclick = () => {
  const record = {
    workName: document.getElementById('popup-work-name').value.trim(),
    nitCost: document.getElementById('popup-nit-cost').value,
    tenderNo: document.getElementById('popup-tender-no').value.trim(),
    fileNo: document.getElementById('popup-file-no').value.trim(),
    dateOpTender: document.getElementById('popup-tender-date').value,
    numBidders: document.getElementById('popup-bidders').value,
    timeCompletion: document.getElementById('popup-completion-time').value
  };
  if (!record.workName) { 
    alert('Name of Work is required'); 
    return; 
  }

  // Save details
  localStorage.setItem('mainData', JSON.stringify(record));

  const n = parseInt(record.numBidders || '1', 10);
  localStorage.setItem('numBidders', isFinite(n) && n > 0 ? n : 1);

  // üîπ Build banner text (skip Firm and Bid No)
  let bannerText = 
    `Name of work: ${record.workName} | NIT Cost: ‚Çπ${record.nitCost} Lakhs | ` +
    `Time of Completion: ${record.timeCompletion} days | No. of Bidders: ${record.numBidders} | ` +
    `Tender No: ${record.tenderNo} | File No: ${record.fileNo} | T-Bid opening Date: ${record.dateOpTender} `;

  document.getElementById("scrollText").innerText = bannerText;

  // continue with opening bidders popup...
  document.getElementById('tenderPopup').style.display = 'none';
  openBiddersPopup(n);
};

// -------- DRAGGABLE + RESTORE NOTES --------
window.addEventListener("DOMContentLoaded", () => {
  const stickyPad = document.getElementById("stickyPad");
  const stickyToolbar = stickyPad.querySelector(".sticky-toolbar");

  function makeDraggable(el, handle) {
    let offsetX, offsetY, dragging = false;

    handle.addEventListener("mousedown", e => {
      if (["BUTTON", "INPUT", "SELECT", "TEXTAREA"].includes(e.target.tagName)) {
        return;
      }
      dragging = true;
      offsetX = e.clientX - el.offsetLeft;
      offsetY = e.clientY - el.offsetTop;
      document.body.style.userSelect = "none";
    });

    document.addEventListener("mousemove", e => {
      if (!dragging) return;
      el.style.left = (e.clientX - offsetX) + "px";
      el.style.top = (e.clientY - offsetY) + "px";
    });

    document.addEventListener("mouseup", () => {
      dragging = false;
      document.body.style.userSelect = "auto";
    });
  }

  // ‚úÖ Restore sticky pad notes from localStorage
  const savedNotes = JSON.parse(localStorage.getItem("notes") || "[]");
  if (savedNotes.length > 0) {
    notes = savedNotes;
    renderNotes();
  }

  makeDraggable(stickyPad, stickyToolbar);
});


window.addEventListener("DOMContentLoaded", () => {
  // Reset button clears all localStorage and reloads
  const resetBtn = document.getElementById("resetBtn");
  if (resetBtn) {
    resetBtn.addEventListener("click", () => {
  localStorage.clear();

  // show Tender popup immediately at center
  const tenderPopup = document.getElementById("tenderPopup");
  if (tenderPopup) {
    tenderPopup.style.display = "flex";

    // hide Cancel so user cannot skip
    const cancelBtn = document.getElementById("popup-cancelBtn");
    if (cancelBtn) cancelBtn.style.display = "none";
  }
});

  }

  // On load: check if tender details exist
  const mainData = JSON.parse(localStorage.getItem("mainData") || "null");
  if (!mainData) {
    const tenderPopup = document.getElementById("tenderPopup");
if (tenderPopup) {
   tenderPopup.style.display = "flex";
  // open popup on load

  // hide Cancel so user must fill details
    const cancelBtn = document.getElementById("popup-cancelBtn");
    if (cancelBtn) cancelBtn.style.display = "none";
}

  }

  // When clicking Next in Tender popup ‚Üí show Bidder popup
  const tenderNextBtn = document.getElementById("nextBtn");
if (tenderNextBtn) {
  tenderNextBtn.addEventListener("click", () => {
    if (typeof saveTenderDetails === "function") {
      saveTenderDetails();
    }

    const bidderPopup = document.getElementById("bidderPopup");
    if (bidderPopup) bidderPopup.style.display = "block";

    const tenderPopup = document.getElementById("tenderPopup");
    if (tenderPopup) tenderPopup.style.display = "none";
  });
}

});

</script>
</body>
</html>


</body>
</html>
